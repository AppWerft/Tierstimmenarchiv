var Map=require("ti.map"),Module=function(e){this.name=e.name,this.maxannotations=e.maxannotations||60*Ti.Platform.displayCaps.logicalDensityFactor,"object"==typeof e.map&&e.map.apiName?this.map=e.map:console.log("Error: options.map is not from type Map"+e.map),console.log(e.map.apiName),this.points=e.points,console.log(this.points),this.image=e.image,this.rightImage=e.rightImage,this.markers_in_map={},this.eventhandlers={},this._importData(),this._startMap();var t=this,i=function(e){t._updateMap(e)};this.removeRegionChangedHandler=function(){this.map.removeEventListener("regionchanged",i)},this.map.addEventListener("regionchanged",i);var t=this;return this.map.addEventListener("click",function(){t.map.removeEventListener("regionchanged",i),setTimeout(function(){t.map.addEventListener("regionchanged",i)},500)}),this};Module.prototype={destroy:function(){this.removeRegionChangedHandler();var e=[];for(id in this.markers_in_map)this.markers_in_map.hasOwnProperty(id)&&e.push(this.markers_in_map[id]);this.map.removeAnnotations(e),this.markers_in_map=null},_importData:function(){for(var e=(new Date).getTime(),t=0;t<this.points.length;t++)this.points[t].id=t;var i=(new Date).getTime();console.log("MarkerManger: importData "+(i-e)+" ms.")},_startMap:function(){var e=this.map.getRegion();this._updateMap({latitude:e.latitude,longitude:e.longitude,latitudeDelta:e.latitudeDelta,longitudeDelta:e.longitudeDelta})},_updateMap:function(e){this.fireEvent("start");var t=(new Date).getTime(),i=[],a=e.latitude-e.latitudeDelta/2,r=e.longitude-e.longitudeDelta/2,n=e.latitude+e.latitudeDelta/2,s=e.longitude+e.longitudeDelta/2;this.points.forEach(function(e){e.lat>a&&e.lat<n&&e.lng>r&&e.lng<s&&i.push(e)});var o=(new Date).getTime();if(console.log("MarkerManger: "+i.length+" marker found in region (unfiltered)"),i.length){var l={to_render:{},to_add:[],to_remove:[]};if(i.length>this.maxannotations){var d=Math.round(Math.sqrt(this.maxannotations)),m=(e.longitudeDelta/d,e.latitudeDelta/d,{}),t=(new Date).getTime(),c=0;i.forEach(function(t){var i=e.longitude-e.longitudeDelta/2,a=e.latitude-e.latitudeDelta/2,r=e.longitudeDelta/d,n=e.latitudeDelta/d,s=Math.floor((t.lng-i)/r),o=Math.floor((t.lat-a)/n),l=s+"_"+o;m[l]?m[l].push(t):(m[l]=[t],c++)}),console.log("MarkerManger: reduced number of markers "+c);var t=(new Date).getTime();for(key in m)m.hasOwnProperty(key)&&(l.to_render[m[key][0].id]=m[key][0])}else i.forEach(function(e){l.to_render[e.id]=e});for(id in this.markers_in_map)this.markers_in_map.hasOwnProperty(id)&&void 0==l.to_render[id]&&(l.to_remove.push(this.markers_in_map[id]),delete this.markers_in_map[id]);for(id in l.to_render)if(l.to_render.hasOwnProperty(id)&&this.markers_in_map&&!this.markers_in_map[id]){var h=Map.createAnnotation({latitude:l.to_render[id].lat,longitude:l.to_render[id].lng,title:l.to_render[id].title,subtitle:l.to_render[id].subtitle,image:l.to_render[id].image?l.to_render[id].image:this.image,rightView:this.rightImage?Ti.UI.createImageView({image:this.rightImage,width:36,height:36}):null,itemId:l.to_render[id].itemId,name:this.name});l.to_add.push(h),this.markers_in_map[id]=h}var o=(new Date).getTime();this.map.removeAnnotations(l.to_remove),this.map.addAnnotations(l.to_add);var o=(new Date).getTime();console.log("MarkerManger: rendering time "+(o-t)+" ms."),this.fireEvent("complete")}},fireEvent:function(e,t){if(this.eventhandlers[e])for(var i=0;i<this.eventhandlers[e].length;i++)this.eventhandlers[e][i].call(this,t)},addEventListener:function(e,t){this.eventhandlers[e]||(this.eventhandlers[e]=[]),this.eventhandlers[e].push(t)},removeEventListener:function(e,t){if(this.eventhandlers[e]){var i=this.eventhandlers[e].filter(function(e){return e!=t});this.eventhandlers[e]=i}}},module.exports=Module;