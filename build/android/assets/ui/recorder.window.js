var TSA=new(require("model/tsa.adapter")),CanvasObject=require("com.wwl.canvas"),LDF=Ti.Platform.displayCaps.logicalDensityFactor,CANVASHEIGHT=320,MAXDURATION=6e4,TICK=50;Math.log10=Math.log10||function(e){return Math.log(e)/Math.LN10};var canvasready=!1;module.exports=function(){function t(){if(a.isRecording()&&i.canvas&&1==canvasready){var e=a.getMaxAmplitude()/2e4;console.log(Math.log10(6e3*e)),i.canvas.beginPath(),i.canvas.moveTo(n,CANVASHEIGHT/2-e*CANVASHEIGHT),i.canvas.lineTo(n,CANVASHEIGHT/2+e*CANVASHEIGHT),n+=LDF,i.canvas.closePath(),i.canvas.stroke()}}var i=Ti.UI.createWindow({backgroundColor:COLOR.LIGHTGREEN});i.canvascontainer=Ti.UI.createScrollView({scrollType:"horizontal",width:Ti.UI.FILL,contentWidth:3e3,top:0,height:CANVASHEIGHT/LDF,contentHeight:CANVASHEIGHT/LDF}),i.canvas=CanvasObject.createCanvasView({backgroundColor:"black",top:0,left:0,width:Ti.UI.FILL,height:Ti.UI.FILL}),i.canvascontainer.add(i.canvas),i.add(i.canvascontainer),i.canvas.addEventListener("load",function(){i.canvas.lineWidth=LDF;for(var e=0;MAXDURATION>e;e++)e%(1e4/TICK)==0&&(i.canvas.strokeStyle="#555555",i.canvas.beginPath(),i.canvas.moveTo(e,CANVASHEIGHT),i.canvas.lineTo(e,0),i.canvas.closePath(),i.canvas.stroke());i.canvas.strokeStyle="#3BFC34",i.canvas.antiAliasing=!0,canvasready=!0}),i.onErrorFn=function(){var e=Ti.Android.createIntent({action:"android.settings.APPLICATION_SETTINGS"});e.addFlags(Ti.Android.FLAG_ACTIVITY_NEW_TASK),Ti.Android.currentActivity.startActivity(e)},Ti.App.addEventListener("uncaughtException",i.onErrorFn);var a=require("titutorial.audiorecorder");a.startRecording({outputFormat:a.OutputFormat_MPEG_4,audioEncoder:a.AudioEncoder_AAC,directoryName:"recordings",maxDuration:MAXDURATION,success:function(e){clearInterval(r)},error:function(t){alert("error => "+e.message),Ti.API.info("error is => "+JSON.stringify(t))}}),Ti.App.removeEventListener("uncaughtException",i.onErrorFn);var r=setInterval(t,TICK),n=0;return i.addEventListener("close",function(e){clearInterval(r),a.stopRecording(),i.canvas=null,canvasready=!1}),i.addEventListener("open",function(e){if(Ti.Android){var t=require("com.alcoapps.actionbarextras");t.setTitle("Tierstimmenarchiv"),t.setFont("Helvetica-Bold"),t.setSubtitle("Aufnahme"),t.displayUseLogoEnabled=!1,t.setStatusbarColor(COLOR.BROWN),t.backgroundColor=COLOR.DARKGREEN,e.source.getActivity().actionBar.displayHomeAsUp=!0;var a=e.source.getActivity();a.actionBar.onHomeIconItemSelected=function(){i.close()}}}),i};